<%- include('../partial/header', {
  title: '제어판',
  script: [
    '/js/control.js'
  ]
}) %>
<%
var fdate = function fdate(ts) {
  if(ts) {
    var m = moment(ts * 1000)
    var c = moment().subtract(2, 'hours')
    if(m > c)
      return m.fromNow()
    else
      return m.calendar()
  } else return '-'
}
var fddate = function fddate(from, to, waiting, processing, complete) {
  if(!from) {
    return waiting
  } else if(!to) {
    return processing
  } else {
    return complete
  }
}
var devices = function devices(n) {
  n = n || 0
  var r = [];
  (n & 1) && r.push('사볼');
  (n & 2) && r.push('팝픈');
  (n & 4) && r.push('리플렉');
  (n & 8) && r.push('너뭐냐');
  return r.join(' + ') || '없음'
}
var errors = [
  '오류 없음',
  '카드 분리 실패 (유저)',
  '카드 등록 실패 (아즈인포)',
  '카드 분리 실패 (아즈인포)',
  '카드 등록 실패 (유저)',
  '카드 등록 실패 (유저)',
  '갱신 취소됨'
];
%>
<header class="text-only">
  <h1> 제어판 </h1>
</header>
<main class="control">
  <div class="content">
    <h2> 기록 </h2>
    <p> 최근 5개의 기록만 보여집니다. </p>
    <ol class="list">
      <% var c = (refresh.length > 5)? 5 : refresh.length %>
      <% for(var i=0; i<c; i++) { %>
        <% var r = refresh[i] %>
        <li value="<%= r.id %>">
          <b><%= fdate(r.request) %></b>에 요청,
          갱신
          <b><%= ['대기 중', '진행 중', '완료'][r.status || 0] %></b>.
          <span class="text-muted">
            <%= devices(r.device) %> |
            <%= errors[r.error] || r.error && '알 수 없는 오류 (' + r.error + ')' || '오류 없음' %>
          </span>
        </li>
      <% } %>
    </ol>
    <h2> 기록 보기 </h2>
    <ul class="list">
      <li>
        팝픈:
        <ul class="list">
          <li>
            <a href="http://popn.azu.kr/<%= user.nickname %>"> http://popn.azu.kr/<%= user.nickname %> </a>
          </li>
          <li class="text-muted" style="text-decoration: strike">
            신 아즈인포 준비 중
          </li>
        </ul>
      </li>
      <li>
        사볼:
        <ul class="list">
          <li class="text-muted">
            구 히비야 뷰어:
            <a href="http://hibiya.azu.kr/<%= user.nickname %>"> http://hibiya.azu.kr/<%= user.nickname %> </a>
          </li>
          <li class="text-muted">
            구 아즈인포:
            <a href="http://sdvx.azu.kr/<%= user.nickname %>"> http://sdvx.azu.kr/<%= user.nickname %> </a>
          </li>
          <li>
            신 아즈인포:
            <a href="http://test.azu.kr/<%= user.nickname %>"> http://test.azu.kr/<%= user.nickname %> </a>
          </li>
          <li>
            기록 비교하기:
            <br />
            <input type="text" id="vs1" value="<%= user.nickname %>" />
            vs
            <input type="text" id="vs2" />
            <button class="btn btn-primary" onclick="location.href='http://test.azu.kr/'+vs1.value+'/vs/'+vs2.value"> 이동 </button>
          </li>
        </ul>
      </li>
    </ul>
    <h2> 갱신 </h2>
    <p>
      <label for="card"> 카드 번호 </label>
      <span style="display: inline-block; position: relative;" id="card-wrapper">
        <input type="text" id="card" placeholder="터치해서 불러오기..." disabled />
        <span style="position: absolute; top: 0; right: 0; bottom: 0; left: 0;"> </span>
      </span>
    </p>
    <p>
      <label for="password"> 비밀번호 </label>
      <input type="text" id="password" maxlength="4" pattern="^[0-9]{4}$" />
    </p>
    <p>
      <label> 기종 </label>
      <input type="checkbox" id="device_1" class="input-devices" value="1" checked/>
      <label for="device_1"> 사볼 </label>
      <input type="checkbox" id="device_2" class="input-devices" value="2" />
      <label for="device_2"> 팝픈 </label>
      <button id="request" class="btn btn-primary"> 갱신 요청 </button>
    </p>
    <span id="loading" class="hidden"> 로드 중... </span>
    <span id="error" class="hidden"> </span>
  </div>
</main>
<%- include('../partial/nav') %>
<%- include('../partial/aside/control') %>
<%- include('../partial/footer') %>
